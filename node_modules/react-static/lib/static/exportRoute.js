"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _regenerator = _interopRequireDefault(require("@babel/runtime/regenerator"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _react = _interopRequireDefault(require("react"));

var _server = require("react-dom/server");

var _reactHelmet = _interopRequireDefault(require("react-helmet"));

var _reactUniversalComponent = require("react-universal-component");

var _webpackFlushChunks = _interopRequireDefault(require("webpack-flush-chunks"));

var _path = _interopRequireDefault(require("path"));

var _fsExtra = _interopRequireDefault(require("fs-extra"));

var _Redirect = _interopRequireDefault(require("./components/Redirect"));

var _plugins = _interopRequireDefault(require("./plugins"));

var _utils = require("../utils");

var _chunkBuilder = require("../utils/chunkBuilder");

var _HtmlWithMeta = _interopRequireDefault(require("./components/HtmlWithMeta"));

var _HeadWithMeta = _interopRequireDefault(require("./components/HeadWithMeta"));

var _BodyWithMeta = _interopRequireDefault(require("./components/BodyWithMeta"));

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(source, true).forEach(function (key) { (0, _defineProperty2["default"])(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(source).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

//
var cachedBasePath;
var cachedHrefReplace;
var cachedSrcReplace;

var _default =
/*#__PURE__*/
function () {
  var _exportRoute = (0, _asyncToGenerator2["default"])(
  /*#__PURE__*/
  _regenerator["default"].mark(function _callee(state) {
    var _state, config, DocumentTemplate, route, siteData, clientStats, incremental, _state2, Comp, sharedHashesByProp, template, data, sharedData, routePath, remove, removeLocation, basePath, hrefReplace, srcReplace, routeInfo, embeddedRouteInfo, meta, chunkNames, head, clientScripts, clientStyleSheets, clientCss, FinalComp, renderToStringAndExtract, appHtml, RenderedComp, DocumentHtml, html, publicPath, htmlFilename, routeInfoFilename, res;

    return _regenerator["default"].wrap(function _callee$(_context) {
      while (1) {
        switch (_context.prev = _context.next) {
          case 0:
            _state = state, config = _state.config, DocumentTemplate = _state.DocumentTemplate, route = _state.route, siteData = _state.siteData, clientStats = _state.clientStats, incremental = _state.incremental;
            _state2 = state, Comp = _state2.Comp;
            sharedHashesByProp = route.sharedHashesByProp, template = route.template, data = route.data, sharedData = route.sharedData, routePath = route.path, remove = route.remove;

            if (!(incremental && remove)) {
              _context.next = 8;
              break;
            }

            if (!(route.path === '404' || route.path === '/')) {
              _context.next = 6;
              break;
            }

            throw new Error("You are attempting to incrementally remove the ".concat(route.path === '404' ? '404' : 'index', " route from your export. This is currently not supported (or recommended) by React Static."));

          case 6:
            removeLocation = _path["default"].join(config.paths.DIST, route.path);
            return _context.abrupt("return", _fsExtra["default"].remove(removeLocation));

          case 8:
            basePath = cachedBasePath || (cachedBasePath = config.basePath);
            hrefReplace = cachedHrefReplace || (cachedHrefReplace = new RegExp("(href=[\"'])\\/(".concat(basePath ? "".concat(basePath, "\\/") : '', ")?([^\\/])"), 'gm'));
            srcReplace = cachedSrcReplace || (cachedSrcReplace = new RegExp("(src=[\"'])\\/(".concat(basePath ? "".concat(basePath, "\\/") : '', ")?([^\\/])"), 'gm')); // This routeInfo will be saved to disk. It should only include the
            // data and hashes to construct all of the props later.

            routeInfo = {
              template: template,
              sharedHashesByProp: sharedHashesByProp,
              data: data,
              path: routePath // This embeddedRouteInfo will be inlined into the HTML for this route.
              // It should include all of the data, including shared data

            };
            embeddedRouteInfo = _objectSpread({}, routeInfo, {
              sharedData: sharedData,
              siteData: siteData
            });
            state = _objectSpread({}, state, {
              routeInfo: routeInfo,
              embeddedRouteInfo: embeddedRouteInfo // Make a place to collect chunks, meta info and head tags

            });
            meta = {};
            chunkNames = [];
            head = {};
            clientScripts = [];
            clientStyleSheets = [];
            clientCss = {};
            // Get the react component from the Comp and pass it the export context. This
            // uses reactContext under the hood to pass down the exportContext, since
            // react's new context api doesn't survive across bundling.
            Comp = config.disableRuntime ? Comp : Comp(embeddedRouteInfo);

            if (route.redirect) {
              FinalComp = function FinalComp() {
                return _react["default"].createElement(_Redirect["default"], {
                  fromPath: route.path,
                  to: route.redirect
                });
              };
            } else {
              FinalComp = function FinalComp(props) {
                return _react["default"].createElement(_reactUniversalComponent.ReportChunks, {
                  report: function report(chunkName) {
                    // if we are building to a absolute path we must make the detected
                    // chunkName relative and matching to the one we set in
                    // generateTemplates
                    if (!config.paths.DIST.startsWith(config.paths.ROOT)) {
                      chunkName = (0, _chunkBuilder.absoluteToRelativeChunkName)(config.paths.ROOT, chunkName);
                    }

                    chunkNames.push(chunkName);
                  }
                }, _react["default"].createElement(Comp, props));
              };
            }

            renderToStringAndExtract = function renderToStringAndExtract(comp) {
              // Rend the app to string!
              var appHtml = (0, _server.renderToString)(comp);

              var _flushChunks = (0, _webpackFlushChunks["default"])(clientStats, {
                chunkNames: chunkNames,
                outputPath: config.paths.DIST
              }),
                  scripts = _flushChunks.scripts,
                  stylesheets = _flushChunks.stylesheets,
                  css = _flushChunks.css;

              clientScripts = scripts;
              clientStyleSheets = stylesheets;
              clientCss = css; // Extract head calls using Helmet synchronously right after renderToString
              // to not introduce any race conditions in the meta data rendering

              var helmet = _reactHelmet["default"].renderStatic();

              head = {
                htmlProps: helmet.htmlAttributes.toComponent(),
                bodyProps: helmet.bodyAttributes.toComponent(),
                base: helmet.base.toComponent(),
                link: helmet.link.toComponent(),
                meta: helmet.meta.toComponent(),
                noscript: helmet.noscript.toComponent(),
                script: helmet.script.toComponent(),
                style: helmet.style.toComponent(),
                title: helmet.title.toComponent()
              };
              return appHtml;
            };

            state = _objectSpread({}, state, {
              meta: meta
            });
            _context.prev = 24;
            _context.next = 27;
            return _plugins["default"].beforeRenderToElement(FinalComp, state);

          case 27:
            FinalComp = _context.sent;

            if (!config.renderToElement) {
              _context.next = 30;
              break;
            }

            throw new Error("config.renderToElement has been deprecated in favor of the " + "'beforeRenderToElement' or 'beforeRenderToHtml' hooks instead.");

          case 30:
            RenderedComp = _react["default"].createElement(FinalComp, null); // Run the beforeRenderToHtml hook
            // Rum the Html hook

            _context.next = 33;
            return _plugins["default"].beforeRenderToHtml(RenderedComp, state);

          case 33:
            RenderedComp = _context.sent;

            if (!config.renderToHtml) {
              _context.next = 36;
              break;
            }

            throw new Error("config.renderToHtml has been deprecated in favor of the " + "'beforeRenderToHtml' or 'beforeHtmlToDocument' hooks instead.");

          case 36:
            appHtml = renderToStringAndExtract(RenderedComp);
            _context.next = 39;
            return _plugins["default"].beforeHtmlToDocument(appHtml, state);

          case 39:
            appHtml = _context.sent;
            _context.next = 47;
            break;

          case 42:
            _context.prev = 42;
            _context.t0 = _context["catch"](24);

            if (_context.t0.then) {
              _context.t0.message = 'Components are not allowed to suspend during static export. Please ' + 'make its data available synchronously and try again!';
            }

            _context.t0.message = "Failed exporting HTML for URL ".concat(route.path, " (").concat(route.template, "): ").concat(_context.t0.message);
            throw _context.t0;

          case 47:
            state = _objectSpread({}, state, {
              head: head,
              clientScripts: clientScripts,
              clientStyleSheets: clientStyleSheets,
              clientCss: clientCss
            });
            _context.t1 = _server.renderToStaticMarkup;
            _context.t2 = _react["default"];
            _context.t3 = DocumentTemplate;
            _context.next = 53;
            return (0, _HtmlWithMeta["default"])(state);

          case 53:
            _context.t4 = _context.sent;
            _context.next = 56;
            return (0, _HeadWithMeta["default"])(state);

          case 56:
            _context.t5 = _context.sent;
            _context.next = 59;
            return (0, _BodyWithMeta["default"])(state);

          case 59:
            _context.t6 = _context.sent;
            _context.t7 = state;
            _context.t8 = {
              Html: _context.t4,
              Head: _context.t5,
              Body: _context.t6,
              state: _context.t7
            };
            _context.t9 = _react["default"].createElement("div", {
              id: "root",
              dangerouslySetInnerHTML: {
                __html: appHtml
              }
            });
            _context.t10 = _context.t2.createElement.call(_context.t2, _context.t3, _context.t8, _context.t9);
            DocumentHtml = (0, _context.t1)(_context.t10);
            // Render the html for the page inside of the base document.
            html = "<!DOCTYPE html>".concat(DocumentHtml);
            _context.next = 68;
            return _plugins["default"].beforeDocumentToFile(html, state);

          case 68:
            html = _context.sent;
            // If the siteRoot is set and we're not in staging, prefix all absolute URLs
            // with the siteRoot
            publicPath = (0, _utils.makePathAbsolute)(process.env.REACT_STATIC_PUBLIC_PATH);

            if (process.env.REACT_STATIC_DISABLE_ROUTE_PREFIXING !== 'true') {
              html = html.replace(hrefReplace, "$1".concat(publicPath, "$3"));
            }

            html = html.replace(srcReplace, "$1".concat(publicPath, "$3")); // If the route is a 404 page, write it directly to 404.html, instead of
            // inside a directory.

            htmlFilename = route.path === '404' ? _path["default"].join(config.paths.DIST, '404.html') : _path["default"].join(config.paths.DIST, route.path, 'index.html'); // Make the routeInfo sit right next to its companion html file

            routeInfoFilename = _path["default"].join(config.paths.DIST, route.path, 'routeInfo.json');
            _context.next = 76;
            return Promise.all([_fsExtra["default"].outputFile(htmlFilename, html), !route.redirect ? _fsExtra["default"].outputJson(routeInfoFilename, routeInfo) : Promise.resolve()]);

          case 76:
            res = _context.sent;
            return _context.abrupt("return", res);

          case 78:
          case "end":
            return _context.stop();
        }
      }
    }, _callee, null, [[24, 42]]);
  }));

  function exportRoute(_x) {
    return _exportRoute.apply(this, arguments);
  }

  return exportRoute;
}();

exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zdGF0aWMvZXhwb3J0Um91dGUuanMiXSwibmFtZXMiOlsiY2FjaGVkQmFzZVBhdGgiLCJjYWNoZWRIcmVmUmVwbGFjZSIsImNhY2hlZFNyY1JlcGxhY2UiLCJzdGF0ZSIsImNvbmZpZyIsIkRvY3VtZW50VGVtcGxhdGUiLCJyb3V0ZSIsInNpdGVEYXRhIiwiY2xpZW50U3RhdHMiLCJpbmNyZW1lbnRhbCIsIkNvbXAiLCJzaGFyZWRIYXNoZXNCeVByb3AiLCJ0ZW1wbGF0ZSIsImRhdGEiLCJzaGFyZWREYXRhIiwicm91dGVQYXRoIiwicGF0aCIsInJlbW92ZSIsIkVycm9yIiwicmVtb3ZlTG9jYXRpb24iLCJub2RlUGF0aCIsImpvaW4iLCJwYXRocyIsIkRJU1QiLCJmcyIsImJhc2VQYXRoIiwiaHJlZlJlcGxhY2UiLCJSZWdFeHAiLCJzcmNSZXBsYWNlIiwicm91dGVJbmZvIiwiZW1iZWRkZWRSb3V0ZUluZm8iLCJtZXRhIiwiY2h1bmtOYW1lcyIsImhlYWQiLCJjbGllbnRTY3JpcHRzIiwiY2xpZW50U3R5bGVTaGVldHMiLCJjbGllbnRDc3MiLCJkaXNhYmxlUnVudGltZSIsInJlZGlyZWN0IiwiRmluYWxDb21wIiwicHJvcHMiLCJjaHVua05hbWUiLCJzdGFydHNXaXRoIiwiUk9PVCIsInB1c2giLCJyZW5kZXJUb1N0cmluZ0FuZEV4dHJhY3QiLCJjb21wIiwiYXBwSHRtbCIsIm91dHB1dFBhdGgiLCJzY3JpcHRzIiwic3R5bGVzaGVldHMiLCJjc3MiLCJoZWxtZXQiLCJIZWxtZXQiLCJyZW5kZXJTdGF0aWMiLCJodG1sUHJvcHMiLCJodG1sQXR0cmlidXRlcyIsInRvQ29tcG9uZW50IiwiYm9keVByb3BzIiwiYm9keUF0dHJpYnV0ZXMiLCJiYXNlIiwibGluayIsIm5vc2NyaXB0Iiwic2NyaXB0Iiwic3R5bGUiLCJ0aXRsZSIsInBsdWdpbnMiLCJiZWZvcmVSZW5kZXJUb0VsZW1lbnQiLCJyZW5kZXJUb0VsZW1lbnQiLCJSZW5kZXJlZENvbXAiLCJiZWZvcmVSZW5kZXJUb0h0bWwiLCJyZW5kZXJUb0h0bWwiLCJiZWZvcmVIdG1sVG9Eb2N1bWVudCIsInRoZW4iLCJtZXNzYWdlIiwicmVuZGVyVG9TdGF0aWNNYXJrdXAiLCJfX2h0bWwiLCJEb2N1bWVudEh0bWwiLCJodG1sIiwiYmVmb3JlRG9jdW1lbnRUb0ZpbGUiLCJwdWJsaWNQYXRoIiwicHJvY2VzcyIsImVudiIsIlJFQUNUX1NUQVRJQ19QVUJMSUNfUEFUSCIsIlJFQUNUX1NUQVRJQ19ESVNBQkxFX1JPVVRFX1BSRUZJWElORyIsInJlcGxhY2UiLCJodG1sRmlsZW5hbWUiLCJyb3V0ZUluZm9GaWxlbmFtZSIsIlByb21pc2UiLCJhbGwiLCJvdXRwdXRGaWxlIiwib3V0cHV0SnNvbiIsInJlc29sdmUiLCJyZXMiLCJleHBvcnRSb3V0ZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7Ozs7OztBQUVBO0FBRUEsSUFBSUEsY0FBSjtBQUNBLElBQUlDLGlCQUFKO0FBQ0EsSUFBSUMsZ0JBQUo7Ozs7Ozs7K0JBRWdCLGlCQUEyQkMsS0FBM0I7QUFBQTs7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBLHFCQVFWQSxLQVJVLEVBRVpDLE1BRlksVUFFWkEsTUFGWSxFQUdaQyxnQkFIWSxVQUdaQSxnQkFIWSxFQUlaQyxLQUpZLFVBSVpBLEtBSlksRUFLWkMsUUFMWSxVQUtaQSxRQUxZLEVBTVpDLFdBTlksVUFNWkEsV0FOWSxFQU9aQyxXQVBZLFVBT1pBLFdBUFk7QUFBQSxzQkFVQ04sS0FWRCxFQVVSTyxJQVZRLFdBVVJBLElBVlE7QUFhWkMsWUFBQUEsa0JBYlksR0FtQlZMLEtBbkJVLENBYVpLLGtCQWJZLEVBY1pDLFFBZFksR0FtQlZOLEtBbkJVLENBY1pNLFFBZFksRUFlWkMsSUFmWSxHQW1CVlAsS0FuQlUsQ0FlWk8sSUFmWSxF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SixZQUFkLEVBQTRCUixJQUE1QixDQUQ0QixFQUU1QixDQUFDeEUsS0FBSyxDQUFDZ0MsUUFBUCxHQUNJZCxvQkFBR21FLFVBQUgsQ0FBY0osaUJBQWQsRUFBaUMxRCxTQUFqQyxDQURKLEdBRUkyRCxPQUFPLENBQUNJLE9BQVIsRUFKd0IsQ0FBWixDQXRPSjs7QUFBQTtBQXNPUkMsWUFBQUEsR0F0T1E7QUFBQSw2Q0E0T1BBLEdBNU9POztBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBLEc7O1dBQWVDLFc7Ozs7U0FBQUEsVyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBSZWFjdCBmcm9tICdyZWFjdCdcclxuaW1wb3J0IHsgcmVuZGVyVG9TdHJpbmcsIHJlbmRlclRvU3RhdGljTWFya3VwIH0gZnJvbSAncmVhY3QtZG9tL3NlcnZlcidcclxuaW1wb3J0IEhlbG1ldCBmcm9tICdyZWFjdC1oZWxtZXQnXHJcbmltcG9ydCB7IFJlcG9ydENodW5rcyB9IGZyb20gJ3JlYWN0LXVuaXZlcnNhbC1jb21wb25lbnQnXHJcbmltcG9ydCBmbHVzaENodW5rcyBmcm9tICd3ZWJwYWNrLWZsdXNoLWNodW5rcydcclxuaW1wb3J0IG5vZGVQYXRoIGZyb20gJ3BhdGgnXHJcbmltcG9ydCBmcyBmcm9tICdmcy1leHRyYSdcclxuXHJcbmltcG9ydCBSZWRpcmVjdCBmcm9tICcuL2NvbXBvbmVudHMvUmVkaXJlY3QnXHJcbmltcG9ydCBwbHVnaW5zIGZyb20gJy4vcGx1Z2lucydcclxuaW1wb3J0IHsgbWFrZVBhdGhBYnNvbHV0ZSB9IGZyb20gJy4uL3V0aWxzJ1xyXG5pbXBvcnQgeyBhYnNvbHV0ZVRvUmVsYXRpdmVDaHVua05hbWUgfSBmcm9tICcuLi91dGlscy9jaHVua0J1aWxkZXInXHJcblxyXG5pbXBvcnQgbWFrZUh0bWxXaXRoTWV0YSBmcm9tICcuL2NvbXBvbmVudHMvSHRtbFdpdGhNZXRhJ1xyXG5pbXBvcnQgbWFrZUhlYWRXaXRoTWV0YSBmcm9tICcuL2NvbXBvbmVudHMvSGVhZFdpdGhNZXRhJ1xyXG5pbXBvcnQgbWFrZUJvZHlXaXRoTWV0YSBmcm9tICcuL2NvbXBvbmVudHMvQm9keVdpdGhNZXRhJ1xyXG5cclxuLy9cclxuXHJcbmxldCBjYWNoZWRCYXNlUGF0aFxyXG5sZXQgY2FjaGVkSHJlZlJlcGxhY2VcclxubGV0IGNhY2hlZFNyY1JlcGxhY2VcclxuXHJcbmV4cG9ydCBkZWZhdWx0IChhc3luYyBmdW5jdGlvbiBleHBvcnRSb3V0ZShzdGF0ZSkge1xyXG4gIGNvbnN0IHtcclxuICAgIGNvbmZpZyxcclxuICAgIERvY3VtZW50VGVtcGxhdGUsXHJcbiAgICByb3V0ZSxcclxuICAgIHNpdGVEYXRhLFxyXG4gICAgY2xpZW50U3RhdHMsXHJcbiAgICBpbmNyZW1lbnRhbCxcclxuICB9ID0gc3RhdGVcclxuXHJcbiAgbGV0IHsgQ29tcCB9ID0gc3RhdGVcclxuXHJcbiAgY29uc3Qge1xyXG4gICAgc2hhcmVkSGFzaGVzQnlQcm9wLFxyXG4gICAgdGVtcGxhdGUsXHJcbiAgICBkYXRhLFxyXG4gICAgc2hhcmVkRGF0YSxcclxuICAgIHBhdGg6IHJvdXRlUGF0aCxcclxuICAgIHJlbW92ZSxcclxuICB9ID0gcm91dGVcclxuXHJcbiAgaWYgKGluY3JlbWVudGFsICYmIHJlbW92ZSkge1xyXG4gICAgaWYgKHJvdXRlLnBhdGggPT09ICc0MDQnIHx8IHJvdXRlLnBhdGggPT09ICcvJykge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXHJcbiAgICAgICAgYFlvdSBhcmUgYXR0ZW1wdGluZyB0byBpbmNyZW1lbnRhbGx5IHJlbW92ZSB0aGUgJHtcclxuICAgICAgICAgIHJvdXRlLnBhdGggPT09ICc0MDQnID8gJzQwNCcgOiAnaW5kZXgnXHJcbiAgICAgICAgfSByb3V0ZSBmcm9tIHlvdXIgZXhwb3J0LiBUaGlzIGlzIGN1cnJlbnRseSBub3Qgc3VwcG9ydGVkIChvciByZWNvbW1lbmRlZCkgYnkgUmVhY3QgU3RhdGljLmBcclxuICAgICAgKVxyXG4gICAgfVxyXG4gICAgY29uc3QgcmVtb3ZlTG9jYXRpb24gPSBub2RlUGF0aC5qb2luKGNvbmZpZy5wYXRocy5ESVNULCByb3V0ZS5wYXRoKVxyXG4gICAgcmV0dXJuIGZzLnJlbW92ZShyZW1vdmVMb2NhdGlvbilcclxuICB9XHJcblxyXG4gIGNvbnN0IGJhc2VQYXRoID0gY2FjaGVkQmFzZVBhdGggfHwgKGNhY2hlZEJhc2VQYXRoID0gY29uZmlnLmJhc2VQYXRoKVxyXG5cclxuICBjb25zdCBocmVmUmVwbGFjZSA9XHJcbiAgICBjYWNoZWRIcmVmUmVwbGFjZSB8fFxyXG4gICAgKGNhY2hlZEhyZWZSZXBsYWNlID0gbmV3IFJlZ0V4cChcclxuICAgICAgYChocmVmPVtcIiddKVxcXFwvKCR7YmFzZVBhdGggPyBgJHtiYXNlUGF0aH1cXFxcL2AgOiAnJ30pPyhbXlxcXFwvXSlgLFxyXG4gICAgICAnZ20nXHJcbiAgICApKVxyXG5cclxuICBjb25zdCBzcmNSZXBsYWNlID1cclxuICAgIGNhY2hlZFNyY1JlcGxhY2UgfHxcclxuICAgIChjYWNoZWRTcmNSZXBsYWNlID0gbmV3IFJlZ0V4cChcclxuICAgICAgYChzcmM9W1wiJ10pXFxcXC8oJHtiYXNlUGF0aCA/IGAke2Jhc2VQYXRofVxcXFwvYCA6ICcnfSk/KFteXFxcXC9dKWAsXHJcbiAgICAgICdnbSdcclxuICAgICkpXHJcblxyXG4gIC8vIFRoaXMgcm91dGVJbmZvIHdpbGwgYmUgc2F2ZWQgdG8gZGlzay4gSXQgc2hvdWxkIG9ubHkgaW5jbHVkZSB0aGVcclxuICAvLyBkYXRhIGFuZCBoYXNoZXMgdG8gY29uc3RydWN0IGFsbCBvZiB0aGUgcHJvcHMgbGF0ZXIuXHJcbiAgY29uc3Qgcm91dGVJbmZvID0ge1xyXG4gICAgdGVtcGxhdGUsXHJcbiAgICBzaGFyZWRIYXNoZXNCeVByb3AsXHJcbiAgICBkYXRhLFxyXG4gICAgcGF0aDogcm91dGVQYXRoLFxyXG4gIH1cclxuXHJcbiAgLy8gVGhpcyBlbWJlZGRlZFJvdXRlSW5mbyB3aWxsIGJlIGlubGluZWQgaW50byB0aGUgSFRNTCBmb3IgdGhpcyByb3V0ZS5cclxuICAvLyBJdCBzaG91bGQgaW5jbHVkZSBhbGwgb2YgdGhlIGRhdGEsIGluY2x1ZGluZyBzaGFyZWQgZGF0YVxyXG4gIGNvbnN0IGVtYmVkZGVkUm91dGVJbmZvID0ge1xyXG4gICAgLi4ucm91dGVJbmZvLFxyXG4gICAgc2hhcmVkRGF0YSxcclxuICAgIHNpdGVEYXRhLFxyXG4gIH1cclxuXHJcbiAgc3RhdGUgPSB7XHJcbiAgICAuLi5zdGF0ZSxcclxuICAgIHJvdXRlSW5mbyxcclxuICAgIGVtYmVkZGVkUm91dGVJbmZvLFxyXG4gIH1cclxuXHJcbiAgLy8gTWFrZSBhIHBsYWNlIHRvIGNvbGxlY3QgY2h1bmtzLCBtZXRhIGluZm8gYW5kIGhlYWQgdGFnc1xyXG4gIGNvbnN0IG1ldGEgPSB7fVxyXG4gIGNvbnN0IGNodW5rTmFtZXMgPSBbXVxyXG4gIGxldCBoZWFkID0ge31cclxuICBsZXQgY2xpZW50U2NyaXB0cyA9IFtdXHJcbiAgbGV0IGNsaWVudFN0eWxlU2hlZXRzID0gW11cclxuICBsZXQgY2xpZW50Q3NzID0ge31cclxuXHJcbiAgbGV0IEZpbmFsQ29tcFxyXG5cclxuICAvLyBHZXQgdGhlIHJlYWN0IGNvbXBvbmVudCBmcm9tIHRoZSBDb21wIGFuZCBwYXNzIGl0IHRoZSBleHBvcnQgY29udGV4dC4gVGhpc1xyXG4gIC8vIHVzZXMgcmVhY3RDb250ZXh0IHVuZGVyIHRoZSBob29kIHRvIHBhc3MgZG93biB0aGUgZXhwb3J0Q29udGV4dCwgc2luY2VcclxuICAvLyByZWFjdCdzIG5ldyBjb250ZXh0IGFwaSBkb2Vzbid0IHN1cnZpdmUgYWNyb3NzIGJ1bmRsaW5nLlxyXG4gIENvbXAgPSBjb25maWcuZGlzYWJsZVJ1bnRpbWUgPyBDb21wIDogQ29tcChlbWJlZGRlZFJvdXRlSW5mbylcclxuXHJcbiAgaWYgKHJvdXRlLnJlZGlyZWN0KSB7XHJcbiAgICBGaW5hbENvbXAgPSAoKSA9PiA8UmVkaXJlY3QgZnJvbVBhdGg9e3JvdXRlLnBhdGh9IHRvPXtyb3V0ZS5yZWRpcmVjdH0gLz5cclxuICB9IGVsc2Uge1xyXG4gICAgRmluYWxDb21wID0gcHJvcHMgPT4gKFxyXG4gICAgICA8UmVwb3J0Q2h1bmtzXHJcbiAgICAgICAgcmVwb3J0PXtjaHVua05hbWUgPT4ge1xyXG4gICAgICAgICAgLy8gaWYgd2UgYXJlIGJ1aWxkaW5nIHRvIGEgYWJzb2x1dGUgcGF0aCB3ZSBtdXN0IG1ha2UgdGhlIGRldGVjdGVkXHJcbiAgICAgICAgICAvLyBjaHVua05hbWUgcmVsYXRpdmUgYW5kIG1hdGNoaW5nIHRvIHRoZSBvbmUgd2Ugc2V0IGluXHJcbiAgICAgICAgICAvLyBnZW5lcmF0ZVRlbXBsYXRlc1xyXG4gICAgICAgICAgaWYgKCFjb25maWcucGF0aHMuRElTVC5zdGFydHNXaXRoKGNvbmZpZy5wYXRocy5ST09UKSkge1xyXG4gICAgICAgICAgICBjaHVua05hbWUgPSBhYnNvbHV0ZVRvUmVsYXRpdmVDaHVua05hbWUoXHJcbiAgICAgICAgICAgICAgY29uZmlnLnBhdGhzLlJPT1QsXHJcbiAgICAgICAgICAgICAgY2h1bmtOYW1lXHJcbiAgICAgICAgICAgIClcclxuICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICBjaHVua05hbWVzLnB1c2goY2h1bmtOYW1lKVxyXG4gICAgICAgIH19XHJcbiAgICAgID5cclxuICAgICAgICA8Q29tcCB7Li4ucHJvcHN9IC8+XHJcbiAgICAgIDwvUmVwb3J0Q2h1bmtzPlxyXG4gICAgKVxyXG4gIH1cclxuXHJcbiAgY29uc3QgcmVuZGVyVG9TdHJpbmdBbmRFeHRyYWN0ID0gY29tcCA9PiB7XHJcbiAgICAvLyBSZW5kIHRoZSBhcHAgdG8gc3RyaW5nIVxyXG4gICAgY29uc3QgYXBwSHRtbCA9IHJlbmRlclRvU3RyaW5nKGNvbXApXHJcbiAgICBjb25zdCB7IHNjcmlwdHMsIHN0eWxlc2hlZXRzLCBjc3MgfSA9IGZsdXNoQ2h1bmtzKGNsaWVudFN0YXRzLCB7XHJcbiAgICAgIGNodW5rTmFtZXMsXHJcbiAgICAgIG91dHB1dFBhdGg6IGNvbmZpZy5wYXRocy5ESVNULFxyXG4gICAgfSlcclxuXHJcbiAgICBjbGllbnRTY3JpcHRzID0gc2NyaXB0c1xyXG4gICAgY2xpZW50U3R5bGVTaGVldHMgPSBzdHlsZXNoZWV0c1xyXG4gICAgY2xpZW50Q3NzID0gY3NzXHJcbiAgICAvLyBFeHRyYWN0IGhlYWQgY2FsbHMgdXNpbmcgSGVsbWV0IHN5bmNocm9ub3VzbHkgcmlnaHQgYWZ0ZXIgcmVuZGVyVG9TdHJpbmdcclxuICAgIC8vIHRvIG5vdCBpbnRyb2R1Y2UgYW55IHJhY2UgY29uZGl0aW9ucyBpbiB0aGUgbWV0YSBkYXRhIHJlbmRlcmluZ1xyXG4gICAgY29uc3QgaGVsbWV0ID0gSGVsbWV0LnJlbmRlclN0YXRpYygpXHJcbiAgICBoZWFkID0ge1xyXG4gICAgICBodG1sUHJvcHM6IGhlbG1ldC5odG1sQXR0cmlidXRlcy50b0NvbXBvbmVudCgpLFxyXG4gICAgICBib2R5UHJvcHM6IGhlbG1ldC5ib2R5QXR0cmlidXRlcy50b0NvbXBvbmVudCgpLFxyXG4gICAgICBiYXNlOiBoZWxtZXQuYmFzZS50b0NvbXBvbmVudCgpLFxyXG4gICAgICBsaW5rOiBoZWxtZXQubGluay50b0NvbXBvbmVudCgpLFxyXG4gICAgICBtZXRhOiBoZWxtZXQubWV0YS50b0NvbXBvbmVudCgpLFxyXG4gICAgICBub3NjcmlwdDogaGVsbWV0Lm5vc2NyaXB0LnRvQ29tcG9uZW50KCksXHJcbiAgICAgIHNjcmlwdDogaGVsbWV0LnNjcmlwdC50b0NvbXBvbmVudCgpLFxyXG4gICAgICBzdHlsZTogaGVsbWV0LnN0eWxlLnRvQ29tcG9uZW50KCksXHJcbiAgICAgIHRpdGxlOiBoZWxtZXQudGl0bGUudG9Db21wb25lbnQoKSxcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gYXBwSHRtbFxyXG4gIH1cclxuXHJcbiAgbGV0IGFwcEh0bWxcclxuXHJcbiAgc3RhdGUgPSB7XHJcbiAgICAuLi5zdGF0ZSxcclxuICAgIG1ldGEsXHJcbiAgfVxyXG5cclxuICB0cnkge1xyXG4gICAgRmluYWxDb21wID0gYXdhaXQgcGx1Z2lucy5iZWZvcmVSZW5kZXJUb0VsZW1lbnQoRmluYWxDb21wLCBzdGF0ZSlcclxuXHJcbiAgICBpZiAoY29uZmlnLnJlbmRlclRvRWxlbWVudCkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXHJcbiAgICAgICAgYGNvbmZpZy5yZW5kZXJUb0VsZW1lbnQgaGFzIGJlZW4gZGVwcmVjYXRlZCBpbiBmYXZvciBvZiB0aGUgYCArXHJcbiAgICAgICAgICBgJ2JlZm9yZVJlbmRlclRvRWxlbWVudCcgb3IgJ2JlZm9yZVJlbmRlclRvSHRtbCcgaG9va3MgaW5zdGVhZC5gXHJcbiAgICAgIClcclxuICAgIH1cclxuXHJcbiAgICBsZXQgUmVuZGVyZWRDb21wID0gPEZpbmFsQ29tcCAvPlxyXG5cclxuICAgIC8vIFJ1biB0aGUgYmVmb3JlUmVuZGVyVG9IdG1sIGhvb2tcclxuICAgIC8vIFJ1bSB0aGUgSHRtbCBob29rXHJcbiAgICBSZW5kZXJlZENvbXAgPSBhd2FpdCBwbHVnaW5zLmJlZm9yZVJlbmRlclRvSHRtbChSZW5kZXJlZENvbXAsIHN0YXRlKVxyXG5cclxuICAgIGlmIChjb25maWcucmVuZGVyVG9IdG1sKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcihcclxuICAgICAgICBgY29uZmlnLnJlbmRlclRvSHRtbCBoYXMgYmVlbiBkZXByZWNhdGVkIGluIGZhdm9yIG9mIHRoZSBgICtcclxuICAgICAgICAgIGAnYmVmb3JlUmVuZGVyVG9IdG1sJyBvciAnYmVmb3JlSHRtbFRvRG9jdW1lbnQnIGhvb2tzIGluc3RlYWQuYFxyXG4gICAgICApXHJcbiAgICB9XHJcblxyXG4gICAgYXBwSHRtbCA9IHJlbmRlclRvU3RyaW5nQW5kRXh0cmFjdChSZW5kZXJlZENvbXApXHJcblxyXG4gICAgYXBwSHRtbCA9IGF3YWl0IHBsdWdpbnMuYmVmb3JlSHRtbFRvRG9jdW1lbnQoYXBwSHRtbCwgc3RhdGUpXHJcbiAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgIGlmIChlcnJvci50aGVuKSB7XHJcbiAgICAgIGVycm9yLm1lc3NhZ2UgPVxyXG4gICAgICAgICdDb21wb25lbnRzIGFyZSBub3QgYWxsb3dlZCB0byBzdXNwZW5kIGR1cmluZyBzdGF0aWMgZXhwb3J0LiBQbGVhc2UgJyArXHJcbiAgICAgICAgJ21ha2UgaXRzIGRhdGEgYXZhaWxhYmxlIHN5bmNocm9ub3VzbHkgYW5kIHRyeSBhZ2FpbiEnXHJcbiAgICB9XHJcbiAgICBlcnJvci5tZXNzYWdlID0gYEZhaWxlZCBleHBvcnRpbmcgSFRNTCBmb3IgVVJMICR7cm91dGUucGF0aH0gKCR7cm91dGUudGVtcGxhdGV9KTogJHtlcnJvci5tZXNzYWdlfWBcclxuICAgIHRocm93IGVycm9yXHJcbiAgfVxyXG5cclxuICBzdGF0ZSA9IHtcclxuICAgIC4uLnN0YXRlLFxyXG4gICAgaGVhZCxcclxuICAgIGNsaWVudFNjcmlwdHMsXHJcbiAgICBjbGllbnRTdHlsZVNoZWV0cyxcclxuICAgIGNsaWVudENzcyxcclxuICB9XHJcblxyXG4gIGNvbnN0IERvY3VtZW50SHRtbCA9IHJlbmRlclRvU3RhdGljTWFya3VwKFxyXG4gICAgPERvY3VtZW50VGVtcGxhdGVcclxuICAgICAgSHRtbD17YXdhaXQgbWFrZUh0bWxXaXRoTWV0YShzdGF0ZSl9XHJcbiAgICAgIEhlYWQ9e2F3YWl0IG1ha2VIZWFkV2l0aE1ldGEoc3RhdGUpfVxyXG4gICAgICBCb2R5PXthd2FpdCBtYWtlQm9keVdpdGhNZXRhKHN0YXRlKX1cclxuICAgICAgc3RhdGU9e3N0YXRlfVxyXG4gICAgPlxyXG4gICAgICA8ZGl2IGlkPVwicm9vdFwiIGRhbmdlcm91c2x5U2V0SW5uZXJIVE1MPXt7IF9faHRtbDogYXBwSHRtbCB9fSAvPlxyXG4gICAgPC9Eb2N1bWVudFRlbXBsYXRlPlxyXG4gIClcclxuXHJcbiAgLy8gUmVuZGVyIHRoZSBodG1sIGZvciB0aGUgcGFnZSBpbnNpZGUgb2YgdGhlIGJhc2UgZG9jdW1lbnQuXHJcbiAgbGV0IGh0bWwgPSBgPCFET0NUWVBFIGh0bWw+JHtEb2N1bWVudEh0bWx9YFxyXG5cclxuICBodG1sID0gYXdhaXQgcGx1Z2lucy5iZWZvcmVEb2N1bWVudFRvRmlsZShodG1sLCBzdGF0ZSlcclxuXHJcbiAgLy8gSWYgdGhlIHNpdGVSb290IGlzIHNldCBhbmQgd2UncmUgbm90IGluIHN0YWdpbmcsIHByZWZpeCBhbGwgYWJzb2x1dGUgVVJMc1xyXG4gIC8vIHdpdGggdGhlIHNpdGVSb290XHJcbiAgY29uc3QgcHVibGljUGF0aCA9IG1ha2VQYXRoQWJzb2x1dGUocHJvY2Vzcy5lbnYuUkVBQ1RfU1RBVElDX1BVQkxJQ19QQVRIKVxyXG4gIGlmIChwcm9jZXNzLmVudi5SRUFDVF9TVEFUSUNfRElTQUJMRV9ST1VURV9QUkVGSVhJTkcgIT09ICd0cnVlJykge1xyXG4gICAgaHRtbCA9IGh0bWwucmVwbGFjZShocmVmUmVwbGFjZSwgYCQxJHtwdWJsaWNQYXRofSQzYClcclxuICB9XHJcblxyXG4gIGh0bWwgPSBodG1sLnJlcGxhY2Uoc3JjUmVwbGFjZSwgYCQxJHtwdWJsaWNQYXRofSQzYClcclxuXHJcbiAgLy8gSWYgdGhlIHJvdXRlIGlzIGEgNDA0IHBhZ2UsIHdyaXRlIGl0IGRpcmVjdGx5IHRvIDQwNC5odG1sLCBpbnN0ZWFkIG9mXHJcbiAgLy8gaW5zaWRlIGEgZGlyZWN0b3J5LlxyXG4gIGNvbnN0IGh0bWxGaWxlbmFtZSA9XHJcbiAgICByb3V0ZS5wYXRoID09PSAnNDA0J1xyXG4gICAgICA/IG5vZGVQYXRoLmpvaW4oY29uZmlnLnBhdGhzLkRJU1QsICc0MDQuaHRtbCcpXHJcbiAgICAgIDogbm9kZVBhdGguam9pbihjb25maWcucGF0aHMuRElTVCwgcm91dGUucGF0aCwgJ2luZGV4Lmh0bWwnKVxyXG5cclxuICAvLyBNYWtlIHRoZSByb3V0ZUluZm8gc2l0IHJpZ2h0IG5leHQgdG8gaXRzIGNvbXBhbmlvbiBodG1sIGZpbGVcclxuICBjb25zdCByb3V0ZUluZm9GaWxlbmFtZSA9IG5vZGVQYXRoLmpvaW4oXHJcbiAgICBjb25maWcucGF0aHMuRElTVCxcclxuICAgIHJvdXRlLnBhdGgsXHJcbiAgICAncm91dGVJbmZvLmpzb24nXHJcbiAgKVxyXG5cclxuICBjb25zdCByZXMgPSBhd2FpdCBQcm9taXNlLmFsbChbXHJcbiAgICBmcy5vdXRwdXRGaWxlKGh0bWxGaWxlbmFtZSwgaHRtbCksXHJcbiAgICAhcm91dGUucmVkaXJlY3RcclxuICAgICAgPyBmcy5vdXRwdXRKc29uKHJvdXRlSW5mb0ZpbGVuYW1lLCByb3V0ZUluZm8pXHJcbiAgICAgIDogUHJvbWlzZS5yZXNvbHZlKCksXHJcbiAgXSlcclxuICByZXR1cm4gcmVzXHJcbn0pXHJcbiJdfQ==